<DOCTYPE html>
	<html lang="en">
		<head>
			<meta charset="UTF-8" />
			<meta name="viewport" content="width=device-width, initial-scale=1.0" />
			<style>
				/* * {
					box-sizing: border-box;
				} */
				body {
					font-family: "Arial", sans-serif;
					background-color: #f4f4f4;
					color: #333;
					line-height: 1.6;
				}

				.container {
					background-color: #fff;
					margin: 20px auto;
					padding: 20px;
					border-radius: 5px;
					box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
					max-width: 800px;
				}

				h1,
				h2 {
					color: #444;
				}

				button {
					background-color: #007bff;
					color: #fff;
					border: none;
					padding: 10px 20px;
					border-radius: 5px;
					cursor: pointer;
					transition: background-color 0.3s ease;
				}

				button:hover {
					background-color: #0056b3;
				}

				video,
				img {
					max-width: 100%;
					border-radius: 5px;
				}

				#header,
				#snapPics,
				#preview,
				#resultTxidPhoto,
				#footer {
					margin-bottom: 20px;
				}

				#resultTxid,
				#costofTransaction {
					word-break: break-all;
					background-color: #f8f9fa;
					padding: 10px;
					border-radius: 5px;
				}

				#publish {
					margin-top: 20px;
				}

				#footer {
					text-align: center;
				}
			</style>
			<title>GITTEX BSV PHOTO APP</title>
			<!-- qrious cdn -->
			<!-- shrink pictures -->

			<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
			<script src="https://unpkg.com/bsv@1.5"></script>
		</head>
		<body>
			<div class="container" id="header">
				<h1>GITTEX BSV PHOTO APP</h1>
				<p>Upload your photos to the blockchain</p>
				<p id="bsvAddress"></p>
				<p id="bsvPrice"></p>
				<p id="balance"></p>
			</div>
			<div class="container" id="snapPics">
				<h2>Take a picture</h2>
				<video id="video" width="640" height="480" autoplay></video>
				<button id="capture">Capture Photo</button>
				<canvas id="canvas" style="display: none"></canvas>
			</div>
			<div class="container" id="preview">
				<h2>Preview</h2>
				<img id="previewPhoto" src="" alt="" />
				<button id="publish">Publish to the Blockchain!</button>
			</div>
			<div class="container" id="resultTxidPhoto">
				<h2>Result</h2>
				<p id="costofTransaction"></p>
				<p id="resultTxid"></p>
				<!-- qr code of txid -->
				<div id="qrcode"></div>
			</div>
			<div class="container" id="addWif">
				<label for="">Import Your Address?</label>
				<input type="password" id="wifImport" />
				<button id="submitWif">Submit</button>
			</div>
			<div class="container" id="footer">
				<p>Â© 2023 by GITTEX BSV PHOTO APP. Proudly created by SmartLedger</p>
			</div>
			<script>
				const Buffer = bsv.deps.Buffer;
				let currentUtxos = [];

				const getUtxos = async (address) => {
					//whatsonchain
					const response = await fetch(
						`https://api.whatsonchain.com/v1/bsv/main/address/${address}/unspent`
					);
					const data = await response.json();
					//convert to whatsonchain format
					const pkh = bsv.Script.buildPublicKeyHashOut(
						bsv.Address.fromString(address)
					).toHex();
					const utxos = [];
					data.forEach((utxo) => {
						utxos.push({
							txid: utxo.tx_hash,
							vout: utxo.tx_pos,
							satoshis: utxo.value,
							script: pkh,
						});
					});
					currentUtxos = utxos;
					return utxos;
				};
				let bsvPrice = 0;
				let date = new Date();
				const getBsvPrice = async () => {
					const response = await fetch(
						`https://api.whatsonchain.com/v1/bsv/main/exchangerate`
					);
					const data = await response.json();
					bsvPrice = data.rate;
					document.getElementById(
						"bsvPrice"
					).innerHTML = `BSV Price: ${bsvPrice.toFixed(2)} USD`;
					return bsvPrice;
				};
				if (!bsvPrice && localStorage.date !== date) {
					getBsvPrice();
					localStorage.setItem("date", date);
				}
				const getBalance = async (address) => {
					const response = await fetch(
						`https://api.whatsonchain.com/v1/bsv/main/address/${address}/balance`
					);
					const data = await response.json();
					const confirmed = data.confirmed;
					const unconfirmed = data.unconfirmed;
					const balance = confirmed + unconfirmed;
					document.getElementById(
						"balance"
					).innerHTML = `Balance: ${balance} satoshis`;
					return balance;
				};
				const generateKeys = () => {
					const privateKey = new bsv.PrivateKey();
					const publicKey = bsv.PublicKey.fromPrivateKey(privateKey);
					const address = bsv.Address.fromPublicKey(publicKey);
					const pkh = bsv.Script.buildPublicKeyHashOut(address).toHex();

					localStorage.setItem("privateKey", privateKey.toString());
					localStorage.setItem("publicKey", publicKey.toString());
					localStorage.setItem("address", address.toString());
					localStorage.setItem("pkh", pkh.toString());
					return { privateKey, publicKey, address };
				};
				if (!localStorage.getItem("privateKey")) {
					generateKeys();
				} else {
					const privateKey = localStorage.getItem("privateKey");
					const publicKey = localStorage.getItem("publicKey");
					const address = localStorage.getItem("address");
					console.log(privateKey);
					console.log(publicKey);
					console.log(address);
					document.getElementById("bsvAddress").innerHTML = address;
					if (currentUtxos.length === 0) {
						getUtxos(address);
					}
					getBalance(address);
				}

				const broadcastTx = async (tx) => {
					// whatsonchain txhex
					const response = await fetch(
						`https://api.whatsonchain.com/v1/bsv/main/tx/raw`,
						{
							method: "POST",
							body: JSON.stringify({ txhex: tx.toString() }),
						}
					);
					const data = await response.json();
					return data;
				};
				//camera
				navigator.mediaDevices
					.getUserMedia({ video: true })
					.then((stream) => {
						videoEl.srcObject = stream;
						videoEl.play();
					})
					.catch((error) => {
						console.error("Error accessing the camera:", error);
					});

				const uploadBtn = document.getElementById("upload");
				const videoEl = document.getElementById("video");
				const resultTxidEl = document.getElementById("resultTxid");
				const resultPhotoEl = document.getElementById("resultPhoto");
				const costofTransactionEl =
					document.getElementById("costofTransaction");
				const publishBtn = document.getElementById("publish");
				const captureBtn = document.getElementById("capture");
				const canvasEl = document.getElementById("canvas");
				const previewPhotoEl = document.getElementById("previewPhoto");

				captureBtn.addEventListener("click", () => {
					canvasEl.width = videoEl.videoWidth;
					canvasEl.height = videoEl.videoHeight;
					canvasEl.getContext("2d").drawImage(videoEl, 0, 0);
					const imageDataURL = canvasEl.toDataURL("image/png");
					previewPhotoEl.src = imageDataURL;
				});

				const createQrc = (txid) => {
					const qr = new QRious({
						element: document.getElementById("qrcode"),
						value: `https://plugins.whatsonchain.com/api/plugin/main/${txid}`,
						size: 200,
					});
					// add to div
					const qrDiv = document.getElementById("qrcode");
					qrDiv.innerHTML = "";
					const canvas = document.createElement("canvas");
					canvas.width = 200;
					canvas.height = 200;
					canvas.style.border = "1px solid #f8f9fa";
					qrDiv.appendChild(canvas);
					// create onclick to open new tab
					canvas.addEventListener("click", () => {
						window.open(
							`https://plugins.whatsonchain.com/api/plugin/main/${txid}`
						);
					});
				};

				publishBtn.addEventListener("click", async () => {
					const privateKey = localStorage.getItem("privateKey");
					const publicKey = localStorage.getItem("publicKey");
					const address = localStorage.getItem("address");
					const pkh = localStorage.getItem("pkh");

					const utxos = getUtxos(address);
					// const balance = await getBalance(address);
					const keyPair = new bsv.PrivateKey(privateKey);
					const tx = new bsv.Transaction().from(utxos);
					const data = canvasEl.toDataURL("image/png").split(",")[1]; // base64 encoded data without prefix
					const dataArray = [
						// bitcom address
						Buffer.from("19HxigV4QyBv3tHpQVcUEQyq1pzZVdoAut", "utf8"),
						// type of data
						Buffer.from("image/png", "utf8"),
						// base64 decoded data
						Buffer.from(data, "utf8"),
					];
					// safedataout
					const myTxOutput = new bsv.Transaction.Output({
						satoshis: 0,
						script: bsv.Script.buildSafeDataOut(dataArray, "utf8"),
					});

					tx.addOutput(myTxOutput);
					const safeDataOut = bsv.Script.buildSafeDataOut(dataArray);
					tx.change(address);
					tx.feePerKb(10);
					tx.sign(keyPair);
					const costofTransaction = tx.getFee();
					costofTransactionEl.innerHTML = costofTransaction;
					const result = await broadcastTx(tx);
					console.log(result);
					// update current utxos
					resultTxidEl.innerHTML = result;
					// create qr code with qrious, add to div
					createQrc(result);
				});
				const submitWifBtn = document.getElementById("submitWif");
				const wifInput = document.getElementById("wifImport");

				submitWifBtn.addEventListener("click", () => {
					if (!confirm("Are you sure you want to import your private key?"))
						return;

					try {
						const wif = wifInput.value;
						const privateKey = bsv.PrivateKey.fromWIF(wif); // Extract private key from WIF
						const publicKey = bsv.PublicKey.fromPrivateKey(privateKey);
						const address = bsv.Address.fromPublicKey(publicKey).toString();
						const pkh = bsv.Script.buildPublicKeyHashOut(
							bsv.Address.fromPublicKey(publicKey)
						).toHex();

						// Update the displayed BSV address on the page
						document.getElementById("bsvAddress").textContent = address;

						// Save the extracted values to local storage
						localStorage.setItem("privateKey", privateKey.toString());
						localStorage.setItem("publicKey", publicKey.toString());
						localStorage.setItem("address", address);
						localStorage.setItem("pkh", pkh);

						alert("Private key imported successfully!");
						location.reload();
					} catch (e) {
						alert("Error: Invalid WIF provided.");
					}
				});
			</script>
		</body>
	</html>
</DOCTYPE>
