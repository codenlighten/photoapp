<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<style>
			body {
				font-family: "Arial", sans-serif;
				background-color: #f4f4f4;
				color: #333;
				line-height: 1.6;
			}
			.container {
				background-color: #fff;
				margin: 20px auto;
				padding: 20px;
				border-radius: 5px;
				box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
				max-width: 800px;
			}

			h1,
			h2 {
				color: #444;
			}

			button {
				background-color: #007bff;
				color: #fff;
				border: none;
				padding: 10px 20px;
				border-radius: 5px;
				cursor: pointer;
				transition: background-color 0.3s ease;
			}

			button:hover {
				background-color: #0056b3;
			}

			video,
			img {
				max-width: 100%;
				border-radius: 5px;
			}

			#header,
			#snapPics,
			#preview,
			#resultTxidPhoto,
			#footer {
				margin-bottom: 20px;
			}

			#resultTxid,
			#costofTransaction {
				word-break: break-all;
				background-color: #f8f9fa;
				padding: 10px;
				border-radius: 5px;
			}

			#publish {
				margin-top: 20px;
			}

			#footer {
				text-align: center;
			}
		</style>
		<title>GITTEX BSV PHOTO APP</title>
		<!-- qrious cdn -->
		<!-- shrink pictures -->

		<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
		<script src="https://unpkg.com/bsv@1.5"></script>
	</head>
	<body>
		<div class="container" id="header">
			<h1>GITTEX BSV Blockchain PHOTO Booth</h1>
			<p>Post your photos to the blockchain</p>
			<p id="bsvAddress"></p>
			<p id="bsvPrice"></p>
			<p id="balance"></p>
		</div>
		<div class="container" id="snapPics">
			<h2>Take a picture</h2>
			<video id="video" width="640" height="480" autoplay></video>
			<button id="capture">Capture Photo</button>
			<canvas id="canvas" style="display: none"></canvas>
		</div>
		<div class="container" id="preview">
			<h2>Preview</h2>
			<img id="previewPhoto" src="" alt="" />
			<button id="publish">Publish to the Blockchain!</button>
		</div>
		<div class="container" id="resultTxidPhoto">
			<h2>Result</h2>
			<p id="costofTransaction"></p>
			<p id="resultTxid"></p>
			<!-- qr code of txid -->
			<div id="qrcode" style="display: none">
				<h2>
					Your Photo has been published to the Blockchain succesfully! Scan the
					QR Code below to view!
				</h2>
				<canvas id="txQrc" style="display: none"></canvas>
			</div>
		</div>
		<div class="container" id="addWif">
			<label for="">Import Your Address?</label>
			<input type="password" id="wifImport" />
			<button id="submitWif">Submit</button>
		</div>
		<div class="container" id="transferFunds">
			<label for="">Transfer Funds</label>
			<label for="availablefunds">Available Funds</label>
			<p id="funds"></p>
			<label for="transferAddress">Transfer Address</label>
			<input type="text" id="transferAddress" />
			<label for="transferAmount">Transfer Amount</label>
			<input type="text" id="transferAmount" />
			<button id="submitTransfer">Submit</button>
		</div>
		<div class="container" id="footer">
			<p>Â© 2023 by GITTEX BSV PHOTO APP. Proudly created by SmartLedger</p>
		</div>
		<script>
			const Buffer = bsv.deps.Buffer;
			let currentUtxos = [];

			const getUtxos = async (address) => {
				//whatsonchain
				const response = await fetch(
					`https://api.whatsonchain.com/v1/bsv/main/address/${address}/unspent`
				);
				const data = await response.json();
				//convert to whatsonchain format
				const pkh = bsv.Script.buildPublicKeyHashOut(
					bsv.Address.fromString(address)
				).toHex();
				const utxos = [];
				data.forEach((utxo) => {
					utxos.push({
						txid: utxo.tx_hash,
						vout: utxo.tx_pos,
						satoshis: utxo.value,
						script: pkh,
					});
				});
				currentUtxos = utxos;
				return utxos;
			};
			let bsvPrice = 0;
			let date = new Date();
			const getBsvPrice = async () => {
				const response = await fetch(
					`https://api.whatsonchain.com/v1/bsv/main/exchangerate`
				);
				const data = await response.json();
				bsvPrice = data.rate;
				document.getElementById(
					"bsvPrice"
				).innerHTML = `BSV Price: ${bsvPrice.toFixed(2)} USD`;
				return bsvPrice;
			};
			if (!bsvPrice && localStorage.date !== date) {
				getBsvPrice();
				localStorage.setItem("date", date);
			}
			const getBalance = async (address) => {
				const response = await fetch(
					`https://api.whatsonchain.com/v1/bsv/main/address/${address}/balance`
				);
				const data = await response.json();
				const confirmed = data.confirmed;
				const unconfirmed = data.unconfirmed;
				const balance = confirmed + unconfirmed;
				document.getElementById(
					"balance"
				).innerHTML = `Balance: ${balance} satoshis`;
				document.getElementById(
					"funds"
				).innerHTML = `Available Funds: ${balance} satoshis`;
				return balance;
			};
			const generateKeys = () => {
				const privateKey = new bsv.PrivateKey();
				const publicKey = bsv.PublicKey.fromPrivateKey(privateKey);
				const address = bsv.Address.fromPublicKey(publicKey);
				const pkh = bsv.Script.buildPublicKeyHashOut(address).toHex();

				localStorage.setItem("privateKey", privateKey.toString());
				localStorage.setItem("publicKey", publicKey.toString());
				localStorage.setItem("address", address.toString());
				localStorage.setItem("pkh", pkh.toString());
				return { privateKey, publicKey, address };
			};
			if (!localStorage.getItem("privateKey")) {
				generateKeys();
			} else {
				const privateKey = localStorage.getItem("privateKey");
				const publicKey = localStorage.getItem("publicKey");
				const address = localStorage.getItem("address");
				console.log(privateKey);
				console.log(publicKey);
				console.log(address);
				document.getElementById("bsvAddress").innerHTML = address;
				if (currentUtxos.length === 0) {
					getUtxos(address);
				}
				getBalance(address);
			}

			const broadcastTx = async (tx) => {
				// whatsonchain txhex
				try {
					const response = await fetch(
						`https://api.whatsonchain.com/v1/bsv/main/tx/raw`,
						{
							method: "POST",
							body: JSON.stringify({ txhex: tx.toString() }),
						}
					);
					console.log(response);
					const data = await response.json();
					return data;
				} catch (e) {
					alert(`Error: ${e}`);
				}
			};
			//camera
			navigator.mediaDevices
				.getUserMedia({ video: true })
				.then((stream) => {
					videoEl.srcObject = stream;
					videoEl.play();
				})
				.catch((error) => {
					console.error("Error accessing the camera:", error);
				});

			const uploadBtn = document.getElementById("upload");
			const videoEl = document.getElementById("video");
			const resultTxidEl = document.getElementById("resultTxid");
			const resultPhotoEl = document.getElementById("resultPhoto");
			const costofTransactionEl = document.getElementById("costofTransaction");
			const publishBtn = document.getElementById("publish");
			const captureBtn = document.getElementById("capture");
			const canvasEl = document.getElementById("canvas");
			const txQrcEl = document.getElementById("txQrc");
			const qrDivEl = document.getElementById("qrcode");
			const previewPhotoEl = document.getElementById("previewPhoto");
			const transferAddressEl = document.getElementById("transferAddress");
			const transferAmountEl = document.getElementById("transferAmount");
			const submitTransferEl = document.getElementById("submitTransfer");

			let imageDataURL;

			captureBtn.addEventListener("click", () => {
				canvasEl.width = videoEl.videoWidth;
				canvasEl.height = videoEl.videoHeight;
				canvasEl.getContext("2d").drawImage(videoEl, 0, 0);

				// Resize the image
				const maxWidth = 400;
				const maxHeight = 300;
				let width = canvasEl.width;
				let height = canvasEl.height;

				if (width > height) {
					if (width > maxWidth) {
						height *= maxWidth / width;
						width = maxWidth;
					}
				} else {
					if (height > maxHeight) {
						width *= maxHeight / height;
						height = maxHeight;
					}
				}

				const canvasResized = document.createElement("canvas");
				canvasResized.width = width;
				canvasResized.height = height;

				const ctx = canvasResized.getContext("2d");
				ctx.drawImage(canvasEl, 0, 0, width, height);

				// Convert to data URL with reduced quality
				imageDataURL = canvasResized.toDataURL("image/png", 0.1);
				previewPhotoEl.src = imageDataURL;
			});

			const createQrc = (txid) => {
				const qr = new QRious({
					element: txQrcEl,
					value: `https://plugins.whatsonchain.com/api/plugin/main/${txid}`,
					size: 200,
				});
				const qrDiv = document.getElementById("qrcode");
				const canvas = qr.canvas;
				canvas.id = "txQrc";
				canvas.style.display = "block";
				canvas.style.margin = "0 auto";
				qrDiv.appendChild(canvas);
				qrDiv.style.display = "block";
				canvas.addEventListener("click", () => {
					window.open(
						`https://plugins.whatsonchain.com/api/plugin/main/${txid}`
					);
				});
				console.log(txid);
			};

			publishBtn.addEventListener("click", async () => {
				try {
					const privateKey = localStorage.getItem("privateKey");
					const publicKey = localStorage.getItem("publicKey");
					const address = localStorage.getItem("address");

					const utxos = await getUtxos(address);

					const keyPair = new bsv.PrivateKey(privateKey);
					const tx = new bsv.Transaction().from(utxos);

					// Convert the data URL to a Blob
					const response = await fetch(imageDataURL);
					const blob = await response.blob();

					// Convert the Blob to an ArrayBuffer
					const buffer = await blob.arrayBuffer();
					const hashed = await bsv.crypto.Hash.sha256(
						Buffer.from("bsv photo app")
					).toString("hex");
					// Use the ArrayBuffer in your data array
					const dataArray = [
						"19HxigV4QyBv3tHpQVcUEQyq1pzZVdoAut",
						Buffer.from(buffer),
						"image/png",
						hashed,
					];
					console.log(`hashed: ${hashed}`);
					const dataScript = bsv.Script.buildSafeDataOut(dataArray);
					const myTxOutput = new bsv.Transaction.Output({
						script: dataScript,
						satoshis: 0,
					});

					tx.addOutput(myTxOutput);
					tx.change(address);
					tx.feePerKb(10);
					tx.sign(keyPair);
					const costofTransaction = tx.getFee();
					costofTransactionEl.innerHTML = `Cost of Transaction:  $${(
						(costofTransaction / 100000000) *
						bsvPrice
					).toFixed(4)} USD | ${costofTransaction} satoshis| ${(
						costofTransaction / 100000000
					).toFixed(8)} BSV`;
					const result = await broadcastTx(tx);
					console.log(result);

					resultTxidEl.innerHTML = `Transaction ID: ${result}`;
					resultTxidEl.addEventListener("click", () => {
						window.open(`https://whatsonchain.com/tx/${result}`);
					});
					await createQrc(result);
				} catch (e) {
					alert(`Error: ${e}`);
				}
			});
			const submitWifBtn = document.getElementById("submitWif");
			const wifInput = document.getElementById("wifImport");

			submitWifBtn.addEventListener("click", () => {
				if (!confirm("Are you sure you want to import your private key?"))
					return;

				try {
					const wif = wifInput.value;
					const privateKey = bsv.PrivateKey.fromWIF(wif); // Extract private key from WIF
					const publicKey = bsv.PublicKey.fromPrivateKey(privateKey);
					const address = bsv.Address.fromPublicKey(publicKey).toString();
					const pkh = bsv.Script.buildPublicKeyHashOut(
						bsv.Address.fromPublicKey(publicKey)
					).toHex();

					// Update the displayed BSV address on the page
					document.getElementById("bsvAddress").textContent = address;

					// Save the extracted values to local storage
					localStorage.setItem("privateKey", privateKey.toString());
					localStorage.setItem("publicKey", publicKey.toString());
					localStorage.setItem("address", address);
					localStorage.setItem("pkh", pkh);

					alert("Private key imported successfully!");
					location.reload();
				} catch (e) {
					alert("Error: Invalid WIF provided.");
				}
			});

			submitTransferEl.addEventListener("click", async () => {
				try {
					const privateKey = localStorage.getItem("privateKey");
					const publicKey = localStorage.getItem("publicKey");
					const address = localStorage.getItem("address");
					const transferAddress = transferAddressEl.value;
					const transferAmount = transferAmountEl.value;
					const utxos = await getUtxos(address);
					const keyPair = new bsv.PrivateKey(privateKey);
					const tx = new bsv.Transaction().from(utxos);
					tx.to(transferAddress, parseInt(transferAmount));
					tx.change(address);
					tx.feePerKb(10);
					tx.sign(keyPair);
					const costofTransaction = tx.getFee();
					costofTransactionEl.innerHTML = `Cost of Transaction:  $${(
						(costofTransaction / 100000000) *
						bsvPrice
					).toFixed(4)} USD | ${costofTransaction} satoshis| ${(
						costofTransaction / 100000000
					).toFixed(8)} BSV`;
					const result = await broadcastTx(tx);
					console.log(result);

					resultTxidEl.innerHTML = `Transaction ID: ${result}`;
					resultTxidEl.addEventListener("click", () => {
						window.open(`https://whatsonchain.com/tx/${result}`);
					});
					await createQrc(result);
				} catch (e) {
					alert(`Error: ${e}`);
				}
			});
		</script>
	</body>
</html>
